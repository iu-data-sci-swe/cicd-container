name: Train Model - Krishna89

on:
  push:
    branches: [ main, add-model-training-workflow ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  train:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Train fraud detection model
      run: |
        python -c "
        import pandas as pd
        import numpy as np
        from sklearn.linear_model import LogisticRegression
        from sklearn.model_selection import train_test_split
        import pickle
        import os
        
        # Create model directory if it doesn't exist
        os.makedirs('model', exist_ok=True)
        
        # Load data
        if os.path.exists('data/fraud_data.csv'):
            df = pd.read_csv('data/fraud_data.csv')
        else:
            # Generate sample data if dataset doesn't exist
            np.random.seed(42)
            n_samples = 1000
            df = pd.DataFrame({
                'amount': np.random.exponential(100, n_samples),
                'time': np.random.randint(0, 86400, n_samples),
                'is_fraud': np.random.binomial(1, 0.1, n_samples)
            })
        
        # Prepare features and target
        X = df.drop('is_fraud', axis=1) if 'is_fraud' in df.columns else df.iloc[:, :-1]
        y = df['is_fraud'] if 'is_fraud' in df.columns else df.iloc[:, -1]
        
        # Split data
        X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)
        
        # Train model
        model = LogisticRegression(random_state=42, max_iter=1000)
        model.fit(X_train, y_train)
        
        # Save model
        with open('model/fraud-model-krishna89.pkl', 'wb') as f:
            pickle.dump(model, f)
        
        # Print accuracy
        accuracy = model.score(X_test, y_test)
        print(f'Model trained successfully! Accuracy: {accuracy:.4f}')
        "
    
    - name: Verify model artifact
      run: |
        ls -lh model/
        echo "Model file created successfully"
    
    - name: Publish trained model
      uses: actions/upload-artifact@v4
      with:
        name: fraud-model-krishna89
        path: model/fraud-model-krishna89.pkl
        retention-days: 30
